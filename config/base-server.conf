# this file should be included in server {}

location /kibana/ {
  access_by_lua_file /etc/nginx/auth/validate.lua;
  proxy_http_version 1.1;
  proxy_pass http://kibana_backend/;
}

location /hellochart {
  root html;
  index index.html;
}

location /qix_session_service {
  # only exposed internally, used during requests to /doc:
  internal;
  proxy_http_version 1.1;
  proxy_pass http://qss_backend/v1/session;
}

location /doc {
  set $qix_session_host '';
  set $qix_session_port '';
  rewrite_by_lua_block {
    local uri = string.sub(ngx.var.request_uri, 5);
    local routeResponse = ngx.location.capture("/qix_session_service" ..  uri);
    if routeResponse.status == 200 then
      local qix_session_route_data = cjson.decode(routeResponse.body);
      ngx.var.qix_session_host = qix_session_route_data.ipAddress;
      ngx.var.qix_session_port = qix_session_route_data.port;
      ngx.req.set_header("X-Qlik-Session", qix_session_route_data.sessionId)
      ngx.req.set_uri("/app/engineData");
    else
      ngx.exit(routeResponse.status);
    end
  }
  proxy_set_header X-Real-IP $proxy_protocol_addr;
  proxy_set_header X-Forwarded-For $proxy_protocol_addr;
  proxy_set_header X-Forwarded-Port 80;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Host $http_host;
  proxy_set_header X-NginX-Proxy true;
  proxy_set_header Connection "Upgrade";
  proxy_set_header Upgrade $http_upgrade;

  proxy_http_version 1.1;
  proxy_pass http://engine_backend/;
}
